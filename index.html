<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Auth System</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.container {
			width: 100%;
			max-width: 400px;
			padding: 20px;
		}

		.card {
			background: #2d2d44;
			border-radius: 8px;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
			padding: 40px;
		}

		h1 {
			margin-bottom: 30px;
			text-align: center;
			color: #e0e0e0;
		}

		.form-group {
			margin-bottom: 20px;
		}

		label {
			display: block;
			margin-bottom: 8px;
			color: #b0b0b0;
			font-weight: 500;
		}

		input {
			width: 100%;
			padding: 12px;
			border: 1px solid #444;
			border-radius: 4px;
			font-size: 14px;
			background: #1a1a2e;
			color: #e0e0e0;
		}

		input:focus {
			outline: none;
			border-color: #667eea;
		}

		button {
			width: 100%;
			padding: 12px;
			background: #667eea;
			color: white;
			border: none;
			border-radius: 4px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
		}

		button:hover {
			background: #5568d3;
		}

		.toggle-form {
			text-align: center;
			margin-top: 20px;
			color: #666;
			font-size: 14px;
		}

		.toggle-form a {
			color: #667eea;
			text-decoration: none;
			cursor: pointer;
			font-weight: 600;
		}

		.hidden {
			display: none;
		}

		.message {
			padding: 12px;
			border-radius: 4px;
			margin-bottom: 20px;
			font-size: 14px;
			text-align: center;
		}

		.message.error {
			background: #fee;
			color: #c33;
			border: 1px solid #fcc;
		}

		.message.success {
			background: #efe;
			color: #3c3;
			border: 1px solid #cfc;
		}

		.dashboard {
			text-align: center;
		}

		.dashboard h2 {
			color: #333;
			margin-bottom: 20px;
		}

		.dashboard p {
			color: #666;
			margin-bottom: 30px;
			font-size: 18px;
		}

		.logout-btn {
			background: #e74c3c;
		}

		.logout-btn:hover {
			background: #c0392b;
		}

		.info-text {
			background: #f0f8ff;
			border-left: 4px solid #667eea;
			padding: 12px;
			margin-bottom: 20px;
			border-radius: 4px;
			font-size: 13px;
			color: #333;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="card">
			<div id="message"></div>

			<!-- Login Form -->
			<div id="login-form">
				<h1>Login</h1>
				<form onsubmit="handleLogin(event)">
					<div class="form-group">
						<label>Email</label>
						<input type="email" id="login-email" required>
					</div>
					<div class="form-group">
						<label>Password</label>
						<input type="password" id="login-password" required>
					</div>
					<button type="submit">Login</button>
				</form>
				<div class="toggle-form">
					Don't have an account? <a onclick="toggleForms()">Register</a>
				</div>
			</div>

			<!-- 2FA Form -->
			<div id="2fa-form" class="hidden">
				<h1>Enter 2FA Code</h1>
				<div class="info-text">
					A 6-digit code has been sent to your email. Please enter it below.
				</div>
				<form onsubmit="handleVerify2FA(event)">
					<div class="form-group">
						<label>2FA Code</label>
						<input type="text" id="2fa-code" placeholder="000000" maxlength="6" required>
					</div>
					<button type="submit">Verify</button>
				</form>
			</div>

			<!-- Register Form -->
			<div id="register-form" class="hidden">
				<h1>Register</h1>
				<form onsubmit="handleRegister(event)">
					<div class="form-group">
						<label>Email</label>
						<input type="email" id="register-email" required>
					</div>
					<div class="form-group">
						<label>Password</label>
						<input type="password" id="register-password" required>
					</div>
					<button type="submit">Register</button>
				</form>
				<div class="toggle-form">
					Already have an account? <a onclick="toggleForms()">Login</a>
				</div>
			</div>

			<!-- Dashboard -->
			<div id="dashboard" class="hidden dashboard">
				<h2>Welcome!</h2>
				<p id="user-email"></p>
				<button class="logout-btn" onclick="handleLogout()">Logout</button>
			</div>
		</div>
	</div>

	<script>
		let token = localStorage.getItem('token');
		let currentEmail = null;

		// Check if token exists and email is stored
		if (token && localStorage.getItem('email')) {
			showDashboard();
		} else {
			// Clear any stale session data
			localStorage.removeItem('token');
			localStorage.removeItem('email');
		}

		function toggleForms() {
			document.getElementById('login-form').classList.toggle('hidden');
			document.getElementById('register-form').classList.toggle('hidden');
			clearMessage();
		}

		function showMessage(text, type) {
			const msg = document.getElementById('message');
			msg.textContent = text;
			msg.className = 'message ' + type;
		}

		function clearMessage() {
			document.getElementById('message').textContent = '';
			document.getElementById('message').className = 'message';
		}

		async function handleRegister(e) {
			e.preventDefault();
			clearMessage();

			const email = document.getElementById('register-email').value;
			const password = document.getElementById('register-password').value;

			try {
				const formData = new FormData();
				formData.append('email', email);
				formData.append('password', password);

				console.log('Sending register request for:', email);
				const response = await fetch('/api/register', {
					method: 'POST',
					body: formData
				});

				console.log('Register response status:', response.status);
				const data = await response.json();
				console.log('Register response data:', data);

				if (response.ok) {
					showMessage('Registered! Please login.', 'success');
					setTimeout(() => {
						document.getElementById('register-email').value = '';
						document.getElementById('register-password').value = '';
						toggleForms();
					}, 1500);
				} else {
					showMessage(data.error || 'Registration failed', 'error');
				}
			} catch (err) {
				console.error('Register error:', err);
				showMessage('Error: ' + err.message, 'error');
			}
		}

		async function handleLogin(e) {
			e.preventDefault();
			clearMessage();

			const email = document.getElementById('login-email').value;
			const password = document.getElementById('login-password').value;

			try {
				const formData = new FormData();
				formData.append('email', email);
				formData.append('password', password);

				console.log('Sending login request for:', email);
				const response = await fetch('/api/login', {
					method: 'POST',
					body: formData
				});

				console.log('Login response status:', response.status);
				const data = await response.json();
				console.log('Login response data:', data);

				if (response.ok) {
					currentEmail = email;
					// Hide login form, show 2FA form
					document.getElementById('login-form').classList.add('hidden');
					document.getElementById('2fa-form').classList.remove('hidden');
					showMessage('Code sent to your email', 'success');
				} else {
					showMessage(data.error || 'Login failed', 'error');
				}
			} catch (err) {
				console.error('Login error:', err);
				showMessage('Error: ' + err.message, 'error');
			}
		}

		async function handleVerify2FA(e) {
			e.preventDefault();
			clearMessage();

			const code = document.getElementById('2fa-code').value;

			try {
				const formData = new FormData();
				formData.append('email', currentEmail);
				formData.append('code', code);

				const response = await fetch('/api/verify-2fa', {
					method: 'POST',
					body: formData
				});

				const data = await response.json();

				if (response.ok) {
					token = data.token;
					localStorage.setItem('token', token);
					localStorage.setItem('email', currentEmail);
					showMessage('Login successful!', 'success');
					setTimeout(showDashboard, 1000);
				} else {
					showMessage(data.error || 'Invalid code', 'error');
				}
			} catch (err) {
				showMessage('Error: ' + err.message, 'error');
			}
		}

		function showDashboard() {
			document.getElementById('login-form').classList.add('hidden');
			document.getElementById('2fa-form').classList.add('hidden');
			document.getElementById('register-form').classList.add('hidden');
			document.getElementById('dashboard').classList.remove('hidden');
			document.getElementById('user-email').textContent = 'Logged in as: ' + localStorage.getItem('email');
		}

		function handleLogout() {
			localStorage.removeItem('token');
			localStorage.removeItem('email');
			currentEmail = null;
			document.getElementById('dashboard').classList.add('hidden');
			document.getElementById('login-form').classList.remove('hidden');
			document.getElementById('2fa-form').classList.add('hidden');
			document.getElementById('login-email').value = '';
			document.getElementById('login-password').value = '';
			document.getElementById('2fa-code').value = '';
			clearMessage();
			showMessage('Logged out successfully', 'success');
			setTimeout(clearMessage, 2000);
		}
	</script>
</body>
</html>
